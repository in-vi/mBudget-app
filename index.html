<!DOCTYPE html>
<html>

<head>
  <title>Budget Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>Budget Tracker</h1>
  <div class="container">
    <div id="message" class="status" style="display: none;"></div>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('home')">Home</div>
      <div class="tab" onclick="switchTab('summary')">Summary</div>
    </div>

    <div id="homeTab" class="tab-content active">
      <div class="form-group">
        <label for="monthSelector">Select Month:</label>
        <select id="monthSelector"></select>
        <button onclick="loadData()">Load Data</button>
      </div>

      <div class="quick-select">
        <button onclick="selectCategory('Groceries')">
          <img src="icons/groceries.png" alt="Groceries">
        </button>
        <button onclick="selectCategory('Eat Out')">
          <img src="icons/eat-out.png" alt="Eat Out">
        </button>
        <button onclick="selectCategory('Public Transportation')">
          <img src="icons/train.png" alt="Public Transportation">
        </button>
      </div>

      <form id="addEntryForm" class="form-group">
        <select id="category" required>
          <option value="">Select Category</option>
        </select>
        <input type="number" id="amount" placeholder="Amount" required step="0.01" min="0" />
        <button type="submit">Add</button>
      </form>
    </div>

    <div id="summaryTab" class="tab-content">
      <div class="total-summary" id="totalSummary"></div>
      <button class="toggle-table-btn" onclick="toggleTable()">Show Expenses</button>
      <div id="output"></div>
    </div>
  </div>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxaXE-fAQnhdqxnwA6Mgopdz40LoMtvPl-ubhtJwresDIPp4W2y_Vtfc1VDF620QTMsuA/exec";

    // Switch between tabs
    function switchTab(tabName) {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => tab.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      if (tabName === 'home') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('homeTab').classList.add('active');
      } else if (tabName === 'summary') {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('summaryTab').classList.add('active');
      }
    }

    // Populate the month dropdown
    function populateMonths() {
      const monthSelector = document.getElementById("monthSelector");
      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      const currentMonthIndex = new Date().getMonth();
      months.forEach((month, index) => {
        const option = document.createElement("option");
        option.value = month;
        option.textContent = month;
        if (index === currentMonthIndex) {
          option.selected = true;
        }
        monthSelector.appendChild(option);
      });
    }

    // Toggle table visibility
    function toggleTable() {
      const table = document.querySelector('table');
      const toggleBtn = document.querySelector('.toggle-table-btn');

      if (table.style.display === 'table') {
        table.style.display = 'none';
        toggleBtn.textContent = 'Show Expenses';
      } else {
        table.style.display = 'table';
        toggleBtn.textContent = 'Hide Expenses';
      }
    }

    // Load data for the selected month
    function loadData() {
      const selectedMonth = document.getElementById("monthSelector").value;
      fetchData(selectedMonth);
    }

    function calculateTotal(data) {
      let total = 0;

      data.forEach(row => {
        const [expenseName, , actuals] = row;

        if (!expenseName || expenseName === "TOTAL" || actuals <= 0) {
          return;
        }

        total += actuals;
      });

      return total;
    }

    // Fetch data from the Google Apps Script
    function fetchData(month) {
      fetch(`${webAppUrl}?month=${encodeURIComponent(month)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            showMessage(data.error, "error");
            return;
          }

          const outputDiv = document.getElementById("output");
          outputDiv.innerHTML = "";

          const table = document.createElement("table");

          const headerRow = document.createElement("tr");
          ["Expense", "Actuals"].forEach(heading => {
            const th = document.createElement("th");
            th.textContent = heading;
            headerRow.appendChild(th);
          });
          table.appendChild(headerRow);

          let totalActuals = calculateTotal(data);

          const categories = new Set();
          data.forEach(row => {
            const [expenseName, , actuals] = row;

            if (!expenseName || expenseName === "Total" || actuals <= 0) {
              return;
            }

            const tr = document.createElement("tr");
            [expenseName, actuals].forEach(value => {
              const td = document.createElement("td");
              td.textContent = typeof value === "number" ? Number(value).toLocaleString() : value;
              tr.appendChild(td);
            });
            table.appendChild(tr);

            categories.add(expenseName);
          });

          outputDiv.appendChild(table);

          const totalSummaryDiv = document.getElementById("totalSummary");
          totalSummaryDiv.innerHTML = `
            <h3>Total Expenses for ${month}</h3>
            <p><strong>${Number(totalActuals).toLocaleString()}</strong></p>
          `;

          populateCategories(categories);
          switchTab('summary');
        })
        .catch(error => {
          showMessage("Error fetching data: " + error.message, "error");
        });
    }

    // Show status message
    function showMessage(message, type) {
      const messageDiv = document.getElementById("message");
      messageDiv.textContent = message;
      messageDiv.className = `status ${type}`;
      messageDiv.style.display = "block";

      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 3000);
    }

    // Handle form submission
    document.getElementById("addEntryForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const category = document.getElementById("category").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const month = document.getElementById("monthSelector").value;

      if (!category || isNaN(amount)) {
        showMessage("Please select a category and enter a valid amount.", "error");
        return;
      }

      const formData = { category, amount, month };

      fetch(webAppUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            showMessage(data.error, "error");
            return;
          }
          showMessage("Data submitted successfully!", "success");
          document.getElementById("amount").value = "";
          loadData();
        })
        .catch(error => {
          showMessage("Error submitting data: " + error.message, "error");
        });
    });

    // Select category based on button click
    function selectCategory(category) {
      const categorySelect = document.getElementById("category");
      categorySelect.value = category;
    }

    // Populate categories from the fetched data
    function populateCategories(categories) {
      const categorySelect = document.getElementById("category");
      categorySelect.innerHTML = '<option value="">Select Category</option>';
      categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(() => console.log("Service Worker Registered"))
          .catch(err => console.error("Service Worker Registration Failed:", err));
      });
    }

    // Initialize
    window.onload = () => {
      populateMonths();
      loadData();
    };
  </script>
</body>

</html>
